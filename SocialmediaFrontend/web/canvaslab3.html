<!DOCTYPE HTML>
<html>

<head>
    <script defer type="text/javascript" src="canvasjs.min.js"></script>
    <script defer type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <script type="text/javascript" >

        var host = "ws://localhost:8082";
        var wSocket = new WebSocket(host);
        var count = 0;
        var time = performance.now();
        var async = true;

        var messageSize;
        var dataPoints = [], chart, chartType = "bar";
        /* Use these to save chart to database */
        var socketAsync = [], socketSync = [];
        var httpAsync = [], httpSync = [];

        window.onload = function() {
            barChart();
        } 
        
        function barChart() {
            chartType = "bar";
            chart = new CanvasJS.Chart("chartContainer", {
                title: {
                    text: "Socket stream, http request, sync, async"
                },
                axisX: {
                    interval: 1,
                    title: "Method of sending ", 
                },
                axisY: {
                    interlacedColor: "rgba(1, 77, 101, .2)",
                    gridColor: "rgba(1, 77, 101,.1)",
                    title:  "Time for vertx server to send messages back",
                    suffix: "ms"

                }, 
                data: [{
                    type: chartType,
                    color: "#014D65", 
                    dataPoints: dataPoints
                }]

            });
            chart.render();
        }
        
        function otherChart() {
            chartType = "Column";
            chart = new CanvasJS.Chart("chartContainer", {
                title: {
                    text: "Socket stream, http request, sync, async"
                },
                axisX: {
                    interval: 1,
                    title: "Method of sending ", 
                },
                axisY: {
                    interlacedColor: "rgba(1, 77, 101, .2)",
                    gridColor: "rgba(1, 77, 101,.1)",
                    title:  "Time for vertx server to send messages back",
                    suffix: "ms"

                }, 
                data: [{
                    type: chartType,
                    color: "#014D65", 
                    dataPoints: dataPoints
                }]

            });
            chart.render();
        }

        function updateChart(duration, label) {
            dataPoints.push({
                y: duration, label: label
            });
            chart.render();
        };

        function init() {
            wSocket.onopen = function() {
                alert(" Web Socket is connected, sending data");
                //wSocket.send("hello you bastard");
            };
            wSocket.onerror = function() {
                alert("Fel!");
            };
        }

        // called when a message is received
        wSocket.onmessage = function(event) {
            if (async) {
                if (count < getNrMessages()-1) {
                    count++;
                } 
                else {
                    var timeAsync = performance.now();
                    var asyncDuration = timeAsync - time;
                    socketAsync.push(asyncDuration);
                    updateChart(asyncDuration, "Socket Async\n#" + getNrMessages().toString());
                    count = 0;
                }
            }
            else { // if synchronous 
                if (count < getNrMessages()-1) {
                    count++;
                    socketSend();
                }
                else {
                    var timeSync = performance.now();
                    var syncDuration = timeSync - time;
                    document.getElementById("text").innerHTML = syncDuration;
                    socketSync.push(syncDuration);
                    updateChart(syncDuration, "Socket Sync\n#" + getNrMessages().toString());
                    count = 0;
                }
            }
        };

        // called when socket closes
        wSocket.onclose = function() {
            alert("Connection is closed... ");
        };

        function socketSendSync() {
            if (getNrMessages() < 100) 
                alert("text should be more than 100 characters");
            else {
                async = false;
                time = performance.now();
                socketSend();
            }
        }

        function socketSend() {
            wSocket.send(document.getElementById("theText").value);
        }

        function socketSendAsync() {
            if (getNrMessages() < 100) 
                alert("text should be more than 100 characters");
            else {
                async = true;
                time = performance.now();
                var i = 0;
                for (i = 0; i < getNrMessages(); i++) {
                    wSocket.send(document.getElementById("theText").value);
                }
            }
        }

        function httpSendAsync() {
            if (getNrMessages() < 100) 
                alert("text should be more than 100 characters");
            else {
                async = true;
                time = performance.now();
                var i = 0;
                for (i = 0; i < getNrMessages(); i++) {
                    doHttpPost();
                }
            }
        }

        function httpSendSync() {
            if (getNrMessages() < 100) 
                alert("text should be more than 100 characters");
            else {
                async = false;
                time = performance.now();
                doHttpPost();
            }
        }

        function doHttpPost() {
            var datavar = document.getElementById("theText").value; //Array 
            $.ajax({
                url : "http://localhost:8083/chunk",
                type: "POST",
                data : datavar,
                success: function(data, textStatus, jqXHR)
                {
                    if (async) {
                        if (count < getNrMessages()-1) {
                            count++;
                        } 
                        else {
                            var timeAsync = performance.now();
                            var asyncDuration = timeAsync - time;
                            httpAsync.push({
                                    duration: asyncDuration
                               , 
                                    label: "Http Async #" + getNrMessages().toString()
                                     
                            });
                            document.getElementById("text").innerHTML = httpAsync;
                            updateChart(asyncDuration, "Http Async #" + getNrMessages().toString());
                            count = 0;
                        }
                    }
                    else { // if synchronous 
                        if (count < getNrMessages()-1) {
                            count++;
                            doHttpPost();
                        }
                        else {
                            var timeSync = performance.now();
                            var syncDuration = timeSync - time;
                            document.getElementById("text").innerHTML = ++count;
                            httpSync.push(syncDuration);
                            updateChart(syncDuration, "Http Sync\n#" + getNrMessages().toString());
                            count = 0;
                        }
                    }
                },
                error: function (jqXHR, textStatus, errorThrown)
                {
                    alert("fail") ; 
                }
            });
        }
        
        function saveToDatabase() {
            var someid = 1;
            var datavar = { 
                        userid: someid
                    , 
                    
                        theChartType: chartType
                    /*, 
                    
                        "theSocketAsync": socketAsync
                    , 
                    
                        theSocketSync: socketSync
                    , 
                    
                        theHttpAsync: httpAsync
                    ,
                    
                        theHttptSync: httpSync*/
            }; //Array 
            //document.getElementById("text").innerHTML = "datavar.toString()";
            //render("text");
            
            $.ajax({
                url : "http://localhost:8083/saveChart",
                type: "POST",
                
                data: JSON.stringify({
                    name:"Bob",
                    test:"lksdklsd"
                }),
                contentType: 'application/json',
                dataType: 'json',
                success: function(data, textStatus, jqXHR)
                {   
                    alert("saved to database");
                },
                error: function (jqXHR, textStatus, errorThrown)
                {
                    alert("fail\n" + jqXHR.toString() + "\n" + textStatus.toString() + "\n" + errorThrown.toString());
                }
            });
        }

        function getNrMessages() {
            return document.getElementById("nrOfMessages").value;
        }

        /* not used currently */
        function median(values) {
            values.sort(function(a, b) {
                return a-b;
            });

            var half = Math.floor(values.length/2);

            if (values.length % 2) 
                return values[half];
            else
                return (values[half-1] + values[half]) / 2.0;
        }
    </script>
</head>

<body>
    <div id="chartContainer" style="height: 300px; width: 100%;" >
    </div>
    <br>
        <h3>Hej</h3><br>
        <form onsubmit="return false">
            Number of messages to send (> 100)<br>
            <input id="nrOfMessages" type="number"><br>
            Message text to be sent<br>
            <input id="theText" type="text"><br>
            <button onclick="socketSendAsync()">Send Socket stream Asynchronous</button><br>
            <button onclick="socketSendSync()">Send Socket stream Synchronous</button><br>
            <button onclick="httpSendAsync()">Send Http Chunk Asynchronous </button><br>
            <button onclick="httpSendSync()">Send Http Chunk Synchronous </button><br><br>
            <button onclick="saveToDatabase()">Save chart to database using http chunk </button><br>
        </form>
        <p id="text"></p>
</body>

</html>
